From 8a7a7ee9228396269735e8dd4561496e96d3e60c Mon Sep 17 00:00:00 2001
From: Christian Stewart <christian@paral.in>
Date: Mon, 22 Nov 2021 20:54:45 -0800
Subject: [PATCH] Adjust flash.sh for flashing Buildroot-produced disk image

Signed-off-by: Christian Stewart <christian@paral.in>
---
 flash.sh | 15 +++++++--------
 1 file changed, 7 insertions(+), 8 deletions(-)

diff --git a/flash.sh b/flash.sh
index e1e1bac..db80a34 100755
--- a/flash.sh
+++ b/flash.sh
@@ -1221,6 +1221,9 @@ function create_fsimg {
 			build_fsimg "${localsysfile}" "${fillpat}" \
 				    "${rootfssize}" "${rootfs_type}" \
 				    "${source_folder}" "${cmdline}" "${do_sign}";
+
+      echo "Skipping image build and setting ${localsysfile} to INITRD.";
+      ln -fs ${INITRD} ${localsysfile};
 		fi;
 
 		if [[ "${rootfs_ab}" == 1 ]]; then
@@ -2187,12 +2190,12 @@ elif [ "${target_rootdev}" == "internal" ] || \
 			bootpartuuid_restore;
 		fi
 
-		cmdline+="root=UUID=${_tmp_uuid} rw rootwait rootfstype=ext4 "
+		cmdline+="root=UUID=${_tmp_uuid} rw rootwait"
 	else
-		cmdline+="root=PARTUUID=${_tmp_uuid} rw rootwait rootfstype=ext4 "
+		cmdline+="root=PARTUUID=${_tmp_uuid} rw rootwait"
 	fi;
 else
-	cmdline+="root=/dev/${target_rootdev} rw rootwait rootfstype=ext4 "
+	cmdline+="root=/dev/${target_rootdev} rw rootwait"
 fi;
 
 if [ "${CMDLINE_ADD}" != "" ]; then
@@ -2455,11 +2458,7 @@ if [ "${write_image_name}" != "" ]; then
 	fi
 fi
 
-if [ "${INITRD_IN_BOOTIMG}" = "yes" ]; then
-	ramdisk=initrd;
-else
-	ramdisk="/dev/null"
-fi
+ramdisk="/dev/null"
 
 if [[ "${rootfs_ab}" == 1 ]]; then
 	if [ "${target_rootdev}" == "external" ] || \
-- 
2.37.3

